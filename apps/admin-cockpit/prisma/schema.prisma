// Smart E-Commerce Platform - Prisma Schema
// Optimized for Neon PostgreSQL with AI features

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User & Authentication
model User {
  id            String    @id @default(cuid())
  clerkId       String    @unique
  email         String    @unique
  firstName     String?
  lastName      String?
  imageUrl      String?
  role          UserRole  @default(CUSTOMER)

  // Customer specific fields
  cart          Cart?
  orders        Order[]
  reviews       Review[]
  wishlist      Wishlist[]
  priceAlerts   PriceAlert[]
  searchHistory SearchHistory[]
  preferences   UserPreference?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([clerkId])
  @@index([email])
}

enum UserRole {
  CUSTOMER
  ADMIN
  SUPER_ADMIN
}

// User Preferences for AI Personalization
model UserPreference {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  categories        String[] // Preferred categories
  priceRangeMin     Float?
  priceRangeMax     Float?
  brands            String[]
  notifyPriceDrops  Boolean  @default(true)
  notifyNewArrivals Boolean  @default(true)
  notifyRestocks    Boolean  @default(false)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
}

// Products
model Product {
  id                String   @id @default(cuid())
  name              String
  slug              String   @unique
  description       String   @db.Text
  shortDescription  String?

  price             Float
  compareAtPrice    Float?   // Original price for discount display
  costPrice         Float?   // For profit calculations

  sku               String   @unique
  barcode           String?

  // Inventory
  stock             Int      @default(0)
  lowStockThreshold Int      @default(10)
  trackInventory    Boolean  @default(true)

  // Organization
  categoryId        String
  category          Category @relation(fields: [categoryId], references: [id])

  brand             String?
  tags              String[]

  // Media
  images            ProductImage[]
  thumbnail         String?
  cloudinaryUrl     String?  // Main Cloudinary image URL
  cloudinaryPublicId String? // Cloudinary public ID for transformations

  // SEO & AI
  metaTitle         String?
  metaDescription   String?
  searchKeywords    String[] // For semantic search
  aiGenerated       Boolean  @default(false) // Track AI-assisted products
  aiImageGenerated  Boolean  @default(false) // AI generated images
  aiDescGenerated   Boolean  @default(false) // AI generated description
  aiTagsGenerated   Boolean  @default(false) // AI generated tags
  vectorId          String?  @unique // Pinecone vector ID for semantic search
  embedding         Json?    // Store embedding vector directly

  // Product specifications (for AI to understand product better)
  specifications    Json?     // Flexible field for product specs
  dimensions        String?   // e.g., "10x20x5 cm"
  weight            Float?    // in grams
  color             String?
  size              String?
  material          String?

  // Status
  status            ProductStatus @default(DRAFT)
  featured          Boolean  @default(false)
  trending          Boolean  @default(false)

  // Variants and Custom Attributes
  variants          ProductVariant[]
  attributes        ProductAttribute[]

  // Base Product relationships
  variantOf         ProductVariant[] @relation("BaseProduct")

  // Relationships
  reviews           Review[]
  cartItems         CartItem[]
  orderItems        OrderItem[]
  wishlist          Wishlist[]
  priceHistory      PriceHistory[]
  priceAlerts       PriceAlert[]

  // Analytics
  views             Int      @default(0)
  purchases         Int      @default(0)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  publishedAt       DateTime?

  @@index([slug])
  @@index([categoryId])
  @@index([status])
  @@index([featured])
  @@index([trending])
  @@index([sku])
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
  OUT_OF_STOCK
}

model ProductImage {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  url       String
  alt       String?
  position  Int      @default(0)

  // Cloudinary metadata
  cloudinaryPublicId String?  // For image transformations and management
  cloudinaryUrl      String?  // Full Cloudinary URL with transformations

  // AI Generation metadata
  aiGenerated       Boolean  @default(false)
  generationPrompt  String?  @db.Text // Prompt used to generate image
  sourceImageUrl    String?  // If generated from an uploaded image
  modelUsed         String?  // e.g., "gemini-pro-vision", "dall-e-3"

  createdAt DateTime @default(now())

  @@index([productId])
}

model Category {
  id          String     @id @default(cuid())
  name        String     @unique
  slug        String     @unique
  description String?    @db.Text
  image       String?

  // SEO & Metadata
  metaTitle       String?
  metaDescription String?
  keywords        String[]  // For search optimization

  // Hierarchy
  parentId    String?
  parent      Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryToCategory")

  products    Product[]

  // Display & Analytics
  position    Int        @default(0)
  isActive    Boolean    @default(true)
  isFeatured  Boolean    @default(false)
  productCount Int       @default(0) // Cache count for performance

  // AI Enhancement
  aiGenerated Boolean    @default(false)
  icon        String?    // Icon name/emoji for category

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([slug])
  @@index([parentId])
  @@index([isActive])
}

// Shopping Cart
model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  items     CartItem[]

  // Abandoned cart recovery
  status    CartStatus @default(ACTIVE)
  recoveryEmailSent Boolean @default(false)
  recoveryEmailSentAt DateTime?

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([userId])
  @@index([status])
}

enum CartStatus {
  ACTIVE
  ABANDONED
  CONVERTED
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productId String
  product   Product  @relation(fields: [productId], references: [id])

  quantity  Int      @default(1)
  price     Float    // Price at time of adding to cart

  // AI Bargaining
  negotiatedPrice Float?
  discountApplied Float?  @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cartId])
  @@index([productId])
}

// Orders
model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique

  userId          String
  user            User        @relation(fields: [userId], references: [id])

  items           OrderItem[]

  // Pricing
  subtotal        Float
  tax             Float       @default(0)
  shipping        Float       @default(0)
  discount        Float       @default(0)
  total           Float

  // Payment
  paymentStatus   PaymentStatus @default(PENDING)
  paymentIntentId String?     @unique // Stripe Payment Intent ID
  paymentMethod   String?

  // Shipping
  shippingAddress Json
  billingAddress  Json
  trackingNumber  String?

  // Status
  status          OrderStatus @default(PENDING)

  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  completedAt     DateTime?
  cancelledAt     DateTime?

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@index([paymentStatus])
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity  Int
  price     Float   // Price at time of purchase

  createdAt DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}

// Reviews
model Review {
  id        String   @id @default(cuid())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  rating    Int      // 1-5
  title     String?
  comment   String   @db.Text

  verified  Boolean  @default(false) // Verified purchase
  helpful   Int      @default(0)

  status    ReviewStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([productId])
  @@index([status])
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

// Wishlist
model Wishlist {
  id        String   @id @default(cuid())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  notifyOnDiscount Boolean @default(true)
  notifyOnRestock  Boolean @default(true)

  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}

// Price Tracking & Alerts
model PriceHistory {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  price     Float

  createdAt DateTime @default(now())

  @@index([productId])
  @@index([createdAt])
}

model PriceAlert {
  id        String   @id @default(cuid())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  targetPrice Float
  triggered   Boolean  @default(false)
  notified    Boolean  @default(false)

  createdAt DateTime @default(now())
  triggeredAt DateTime?

  @@index([userId])
  @@index([productId])
  @@index([triggered])
}

// Search & AI
model SearchHistory {
  id        String   @id @default(cuid())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  query     String
  results   Int      @default(0)
  clicked   String[] // Product IDs that were clicked

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

// Admin Analytics
model TrendAnalysis {
  id            String   @id @default(cuid())

  productId     String?
  category      String?

  metric        String   // e.g., "views", "sales", "searches"
  value         Float
  change        Float    // Percentage change

  period        String   // e.g., "daily", "weekly", "monthly"
  date          DateTime

  aiPrediction  Boolean  @default(false)
  confidence    Float?   // 0-1 for AI predictions

  createdAt     DateTime @default(now())

  @@index([productId])
  @@index([date])
  @@index([metric])
}

// Stock Alerts
model StockAlert {
  id          String   @id @default(cuid())
  productId   String

  level       StockLevel
  threshold   Int
  resolved    Boolean  @default(false)

  createdAt   DateTime @default(now())
  resolvedAt  DateTime?

  @@index([productId])
  @@index([resolved])
}

enum StockLevel {
  LOW
  OUT_OF_STOCK
  OVERSTOCKED
}

// Product Variants (e.g., different sizes, colors)
model ProductVariant {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  name        String   // e.g., "Small - Red", "Medium - Blue"
  sku         String   @unique
  barcode     String?

  // Pricing
  price       Float
  compareAtPrice Float?
  costPrice   Float?

  // Inventory
  stock       Int      @default(0)

  // Variant specifics
  options     Json     // e.g., {"size": "M", "color": "Red"}

  // Media
  image       String?
  images      String[]

  // Base Product Configuration
  isBaseProduct Boolean  @default(false)
  baseProductId String?  // Reference to base product SKU
  baseProduct   Product? @relation("BaseProduct", fields: [baseProductId], references: [id])

  // Status
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([productId])
  @@index([sku])
  @@index([isBaseProduct])
  @@index([baseProductId])
}

// Custom Attribute Definitions (Admin creates these)
model AttributeDefinition {
  id          String   @id @default(cuid())
  name        String   @unique  // e.g., "Warranty Period", "Material Type"
  slug        String   @unique
  description String?

  // Data type for the attribute
  dataType    AttributeDataType @default(TEXT)

  // Validation rules
  isRequired  Boolean  @default(false)
  options     String[] // For SELECT type: predefined options
  unit        String?  // e.g., "cm", "kg", "months"

  // Display
  displayOrder Int     @default(0)
  isActive    Boolean  @default(true)

  // Relationships
  attributes  ProductAttribute[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([slug])
  @@index([isActive])
}

enum AttributeDataType {
  TEXT
  NUMBER
  BOOLEAN
  SELECT
  DATE
  JSON
}

// Product Attributes (Values for each product)
model ProductAttribute {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  attributeDefinitionId String
  attributeDefinition   AttributeDefinition @relation(fields: [attributeDefinitionId], references: [id], onDelete: Cascade)

  // The actual value (stored as JSON for flexibility)
  value       Json

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([productId, attributeDefinitionId])
  @@index([productId])
  @@index([attributeDefinitionId])
}

// Promotion Engine Models
model Promotion {
  id              String          @id @default(cuid())
  name            String
  description     String?         @db.Text
  code            String?         @unique // Coupon code if applicable

  // Promotion Type
  type            PromotionType

  // Discount Configuration
  discountType    DiscountType
  discountValue   Float           // Percentage or fixed amount
  maxDiscount     Float?          // Max discount cap for percentage

  // Applicability
  applyTo         ApplyToType     @default(ORDER)

  // Target Entities (JSON arrays of IDs)
  productIds      String[]        @default([])
  categoryIds     String[]        @default([])
  customerIds     String[]        @default([])

  // Conditions
  minPurchase     Float?
  minQuantity     Int?
  maxQuantity     Int?

  // BOGO Configuration
  bogoConfig      Json?           // {buyQty: 2, getQty: 1, applyTo: "same"|"different"}

  // Free Gift Configuration
  freeGiftConfig  Json?           // {productIds: [], quantity: 1}

  // Usage Limits
  usageLimit      Int?            // Total usage limit
  perUserLimit    Int?            // Per user limit
  usageCount      Int             @default(0)

  // Validity
  startDate       DateTime
  endDate         DateTime
  isActive        Boolean         @default(true)

  // Priority (higher = applied first)
  priority        Int             @default(0)

  // Stacking
  canStack        Boolean         @default(false)
  stacksWith      String[]        @default([]) // IDs of promotions it can stack with

  // AI Personalization
  isAIGenerated   Boolean         @default(false)
  aiConfig        Json?           // AI personalization config

  // Visibility
  isPublic        Boolean         @default(true)
  showOnWebsite   Boolean         @default(true)

  // Metadata
  tags            String[]        @default([])
  internalNotes   String?         @db.Text

  // Relationships
  usage           PromotionUsage[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([code])
  @@index([type])
  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
}

enum PromotionType {
  COUPON              // Code-based discount
  AUTOMATIC           // Auto-applied discount
  CART_DISCOUNT       // Cart-level discount
  PRODUCT_DISCOUNT    // Product-level discount
  CATEGORY_DISCOUNT   // Category-level discount
  BOGO                // Buy One Get One
  FREE_GIFT           // Free gift with purchase
  FREE_SHIPPING       // Free shipping
  CUSTOMER_SPECIFIC   // Customer-specific promotion
  AI_PERSONALIZED     // AI-generated personalized offer
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
  FIXED_PRICE         // Set product to specific price
}

enum ApplyToType {
  ORDER               // Apply to entire order
  PRODUCT             // Apply to specific products
  CATEGORY            // Apply to specific categories
  SHIPPING            // Apply to shipping
  CHEAPEST            // Apply to cheapest item
  MOST_EXPENSIVE      // Apply to most expensive item
}

// Track promotion usage
model PromotionUsage {
  id            String    @id @default(cuid())

  promotionId   String
  promotion     Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  userId        String?
  orderId       String?

  // Discount applied
  discountAmount Float

  // Context
  cartValue     Float?
  orderTotal    Float?

  createdAt     DateTime  @default(now())

  @@index([promotionId])
  @@index([userId])
  @@index([orderId])
  @@index([createdAt])
}
